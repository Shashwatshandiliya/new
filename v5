import React, { useState, useEffect } from "react";
import {
  Box,
  Button,
  Grid,
  TextField,
  Typography,
  IconButton,
  Select,
  MenuItem,
  InputLabel,
  FormControl,
  OutlinedInput,
  Chip,
  Snackbar,
  Alert,
  CircularProgress
} from "@mui/material";
import ArrowBackIcon from "@mui/icons-material/ArrowBack";
import styles from "./CreateEntitlementUser.module.css";
import { Service } from "../../../Root/import";
import { ContainerProvider } from "../../../Root/import";

interface EditEntitlementUserProps {
  accountId: string;
  selectedApp: string;
  onBack: () => void;
}

interface AccountDetails {
  accountName: string;
  accountOwner: string;
  accountType: string;
  accountStatus: string;
  accountDescription: string;
  isPrivileged: string;
  lastLogin: string;
  accessRoles: {
    roleName: string;
    entitlementName: string;
    entitlementDescription: string;
    entitlementOwner: string;
    isPrivileged: string;
  }[];
  applicationName: string;    
}

const BASE_URL = "/fmces/p00/restService/onecert/v1";

export default function EditEntitlementUser({ accountId, selectedApp, onBack }: EditEntitlementUserProps) {
  const [accountDetails, setAccountDetails] = useState<AccountDetails | null>(null);
  const [roles, setRoles] = useState<string[]>([]);
  const [originalRoles, setOriginalRoles] = useState<string[]>([]);
  const [loading, setLoading] = useState(false);
  const [roleOptions, setRoleOptions] = useState<string[]>([]);
  const [snackbarOpen, setSnackbarOpen] = useState(false);
  const [snackbarMessage, setSnackbarMessage] = useState("");
  const [snackbarSeverity, setSnackbarSeverity] = useState<"success" | "error" | "info">("success");
  const [ContainerStore] = ContainerProvider.useContext();
  const userId = ContainerStore?.user?.userId;

  useEffect(() => {
    const fetchAccount = async () => {
      try {
        setLoading(true);
        const headers = {
          applicationName: selectedApp,
          user_id: userId,
          access_token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyX25hbWUiOiIyMDAyMTM1Iiwic2NvcGUiOlsiYXV0aGVudGljYXRpb24iXSwiaXNzIjoiZm1hYSIsImV4cCI6MTc1NTk0ODkxOCwiY2xpZW50X2lkIjoiMjAwMjEzNSIsImF1dGhvcml0aWVzIjpbIm9hdXRoMiJdLCJqdGkiOiI4MWJjZDNiNi00ZTU3LTQ5M2YtYjE1NC1hOGEwOWVmOGI5NDEifQ.awfDsU8u6lDUoBPHLsD9t-pCBFwmxtddaWQtZB276j2enhic8a1iz2KBpqs3a3kGmV8ZrhhcT595uXnDWPjsrL6kdtnCfIPyV6CMR-IOWXqksj7NooZ9eUCrpHdm56LVU33DBA_lkZLjPp48YC09npj4202m-OQQrJOCaPFfv9KNdkc9Fg1OPSOLdxQqRjymA2H64Jq1uv3BWe1qA6EqAMCoNsFiALTS-NVWW_CJlGPHL2ZSJXupDltCxaov9CXqO04PBaUWV_EDdsIyasobcQ-GSGiOAYR5LHjKRsX7yzu5gVtCkn7CuslBdsNprCGdvho7f5x7eIqQWfT0RmVc2g"
        };

        const accountResponse = await Service.getService(
          `${BASE_URL}/account/${encodeURIComponent(accountId)}`,
          { headers }
        );

        setAccountDetails(accountResponse.data);
        const roleList = (accountResponse.data.accessRoles || []).map((r: any) => r.roleName);
        setRoles(roleList);
        setOriginalRoles(roleList);

        const rolesResponse = await Service.getService(
          `${BASE_URL}/entitlement`,
          { headers }
        );

        const allRoles = rolesResponse.data.entitlements.map(
          (e: any) => e.entitlementName
        );
        setRoleOptions(Array.from(new Set(allRoles)));
      } catch (err) {
        console.error("Error fetching account details", err);
        setSnackbarMessage("Failed to fetch account details.");
        setSnackbarSeverity("error");
        setSnackbarOpen(true);
      } finally {
        setLoading(false);
      }
    };

    fetchAccount();
  }, [accountId, selectedApp]);

  const handleSave = async () => {
    if (!accountDetails) return;
    
    const added = roles.filter(r => !originalRoles.includes(r));
    const removed = originalRoles.filter(r => !roles.includes(r));

    if (added.length === 0 && removed.length === 0) {
      setSnackbarMessage("No changes detected.");
      setSnackbarSeverity("info");
      setSnackbarOpen(true);
      return;
    }

    try {
      setLoading(true);
      
      const headers = {
        applicationName: selectedApp,
        user_id: userId,
        access_token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyX25hbWUiOiIyMDAyMTM1Iiwic2NvcGUiOlsiYXV0aGVudGljYXRpb24iXSwiaXNzIjoiZm1hYSIsImV4cCI6MTc1NTk0ODkxOCwiY2xpZW50X2lkIjoiMjAwMjEzNSIsImF1dGhvcml0aWVzIjpbIm9hdXRoMiJdLCJqdGkiOiI4MWJjZDNiNi00ZTU3LTQ5M2YtYjE1NC1hOGEwOWVmOGI5NDEifQ.awfDsU8u6lDUoBPHLsD9t-pCBFwmxtddaWQtZB276j2enhic8a1iz2KBpqs3a3kGmV8ZrhhcT595uXnDWPjsrL6kdtnCfIPyV6CMR-IOWXqksj7NooZ9eUCrpHdm56LVU33DBA_lkZLjPp48YC09npj4202m-OQQrJOCaPFfv9KNdkc9Fg1OPSOLdxQqRjymA2H64Jq1uv3BWe1qA6EqAMCoNsFiALTS-NVWW_CJlGPHL2ZSJXupDltCxaov9CXqO04PBaUWV_EDdsIyasobcQ-GSGiOAYR5LHjKRsX7yzu5gVtCkn7CuslBdsNprCGdvho7f5x7eIqQWfT0RmVc2g"
      };

      // First add new entitlements
      if (added.length > 0) {
        const addPayload = {
          ...accountDetails,
          accessRoles: added.map(role => ({ 
            roleName: role,
            entitlementName: role,
            entitlementDescription: `Added entitlement: ${role}`,
            entitlementOwner: accountDetails.accountOwner,
            isPrivileged: "No"
          }))
        };
        
        await Service.postService(
          `${BASE_URL}/addEntitlement`,
          addPayload,
          { headers }
        );
      }

      // Then remove entitlements
      if (removed.length > 0) {
        const removePayload = {
          ...accountDetails,
          accessRoles: removed.map(role => ({ 
            roleName: role,
            entitlementName: role,
            entitlementDescription: `Removed entitlement: ${role}`,
            entitlementOwner: accountDetails.accountOwner,
            isPrivileged: "No"
          }))
        };
        
        await Service.postService(
          `${BASE_URL}/removeEntitlement`,
          removePayload,
          { headers }
        );
      }

      // Refresh the account data
      const { data } = await Service.getService(
        `${BASE_URL}/account/${encodeURIComponent(accountId)}`,
        { headers }
      );
      
      setAccountDetails(data);
      const updatedRoles = (data.accessRoles || []).map((r: any) => r.roleName);
      setRoles(updatedRoles);
      setOriginalRoles(updatedRoles);

      setSnackbarMessage("Roles updated successfully.");
      setSnackbarSeverity("success");
      setSnackbarOpen(true);
    } catch (error) {
      console.error("Error updating roles", error);
      setSnackbarMessage("Failed to update roles. Please try again.");
      setSnackbarSeverity("error");
      setSnackbarOpen(true);
    } finally {
      setLoading(false);
    }
  };

  if (!accountDetails) {
    return (
      <Box className={styles.container}>
        <Box className={styles.header}>
          <IconButton onClick={onBack} sx={{ color: "white" }}>
            <ArrowBackIcon />
          </IconButton>
          <Typography variant="h6" sx={{ color: "white", ml: 1 }}>
            Loading account details...
          </Typography>
        </Box>
        <Box sx={{ display: 'flex', justifyContent: 'center', mt: 4 }}>
          <CircularProgress sx={{ color: '#2BCBC1' }} />
        </Box>
      </Box>
    );
  }

  return (
    <Box className={styles.container}>
      <Box className={styles.header}>
        <IconButton onClick={onBack} sx={{ color: "white" }}>
          <ArrowBackIcon />
        </IconButton>
        <Typography variant="h6" sx={{ color: "white", ml: 1 }}>
          Edit Account - {accountDetails.accountName}
        </Typography>
      </Box>

      <Box className={styles.formCard}>
        <Typography className={styles.sectionTitle}>Account Details</Typography>
        <Grid container spacing={2} sx={{ mt: 1 }}>
          <Grid item xs={12} sm={6}>
            <TextField
              fullWidth
              label="Bank ID"
              size="small"
              value={accountDetails.accountOwner}
              disabled
              InputProps={{ sx: { backgroundColor: "#2F3A45", color: "white" } }}
              InputLabelProps={{ sx: { color: "#CBCBCB" } }}
            />
          </Grid>
          <Grid item xs={12} sm={6}>
            <TextField
              fullWidth
              label="Account Name"
              size="small"
              value={accountDetails.accountName}
              disabled
              InputProps={{ sx: { backgroundColor: "#2F3A45", color: "white" } }}
              InputLabelProps={{ sx: { color: "#CBCBCB" } }}
            />
          </Grid>

          <Grid item xs={12}>
            <FormControl fullWidth size="small">
              <InputLabel sx={{ color: "#CBCBCB" }}>Role(s)</InputLabel>
              <Select
                multiple
                value={roles}
                onChange={(e) => setRoles(e.target.value as string[])}
                input={<OutlinedInput label="Role(s)" />}
                renderValue={(selected) => (
                  <Box sx={{ display: "flex", flexWrap: "wrap", gap: 0.5 }}>
                    {selected.map((value) => (
                      <Chip
                        key={value}
                        label={value}
                        sx={{ backgroundColor: "#007BFF", color: "white" }}
                      />
                    ))}
                    {selected.length === 0 && (
                      <Typography sx={{ color: '#888', fontStyle: 'italic' }}>
                        No roles selected
                      </Typography>
                    )}
                  </Box>
                )}
                sx={{
                  backgroundColor: "#1E252D",
                  color: "white",
                  borderRadius: 1,
                }}
              >
                {roleOptions.map((role) => (
                  <MenuItem key={role} value={role}>
                    {role}
                  </MenuItem>
                ))}
              </Select>
            </FormControl>
          </Grid>

          <Grid item xs={12} sm={6}>
            <TextField
              fullWidth
              label="Account Type"
              size="small"
              value={accountDetails.accountType}
              disabled
              InputProps={{ sx: { backgroundColor: "#2F3A45", color: "white" } }}
              InputLabelProps={{ sx: { color: "#CBCBCB" } }}
            />
          </Grid>
          <Grid item xs={12} sm={6}>
            <TextField
              fullWidth
              label="Status"
              size="small"
              value={accountDetails.accountStatus}
              disabled
              InputProps={{ sx: { backgroundColor: "#2F3A45", color: "white" } }}
              InputLabelProps={{ sx: { color: "#CBCBCB" } }}
            />
          </Grid>
        </Grid>

        <Box sx={{ mt: 3, display: "flex", gap: 2, justifyContent: "flex-end" }}>
          <Button variant="outlined" color="inherit" onClick={onBack} sx={{ textTransform: "none" }}>
            Cancel
          </Button>
          <Button
            variant="contained"
            onClick={handleSave}
            disabled={loading}
            sx={{ textTransform: "none" }}
          >
            {loading ? <CircularProgress size={24} /> : "Save"}
          </Button>
        </Box>
      </Box>

      <Snackbar
        open={snackbarOpen}
        autoHideDuration={3000}
        onClose={() => setSnackbarOpen(false)}
        anchorOrigin={{ vertical: "bottom", horizontal: "center" }}
      >
        <Alert severity={snackbarSeverity} onClose={() => setSnackbarOpen(false)} sx={{ width: "100%" }}>
          {snackbarMessage}
        </Alert>
      </Snackbar>
    </Box>
  );
}
