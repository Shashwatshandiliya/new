import * as React from "react";
import Grid from "@mui/material/Grid";
import IconButton from "@mui/material/IconButton";
import Button from "@mui/material/Button";
import Box from "@mui/material/Box";
import MaterialTable from "../../../Root/components/MaterialTable";
import { InputAdornment, Select, TextField, Typography } from "@mui/material";
import AddCircleIcon from "@mui/icons-material/AddCircle";
import FolderIcon from '@mui/icons-material/Folder';
import CalendarTodayIcon from "@mui/icons-material/CalendarToday";
import { Tabs } from "antd";
import Drawer from "@mui/material/Drawer";
import styles from "./AppManagement.module.css";
import EditIcon from '@mui/icons-material/Edit';
import DeleteIcon from '@mui/icons-material/Delete';
import Menu from "@mui/material/Menu";
import MenuItem from "@mui/material/MenuItem";
import axios from "axios";

const { TabPane } = Tabs;

interface AppManagementProps {
  onNavigate?: (tab: string) => void;
}

interface AppManagementRow {
  "app name": string;
  "app id": string;
  "appUID": string;  // Added for feature mapping
  status: string;
  "appDesc": string;
  "number of features": string;
  "number of actions": string;
  "last modified": string;
  features: { name: string; featureId: string; status: string; usersAssigned: string; lastModified: string }[];
  actions: { name: string; actionId: string; status: string; usersAssigned: string; lastModified: string }[];
}

const AppManagementview: React.FC<AppManagementProps> = ({ onNavigate }) => {
  // Existing state and logic remains same
  const [activeAppTab, setActiveAppTab] = React.useState<string>("1");
  const [tabRow, setTabRow] = React.useState<AppManagementRow[]>([]);
  const [rowCount, setRowCount] = React.useState<number>(0);
  const [selectedDate, setSelectedDate] = React.useState<string>("");
  const [isDrawerOpen, setIsDrawerOpen] = React.useState<boolean>(false);
  const [drawerData, setDrawerData] = React.useState<AppManagementRow | null>(null);
  const [featuresData, setFeaturesData] = React.useState<Array<{
    name: string;
    featureId: string;
    status: string;
    usersAssigned: string;
    lastModified: string;
    applicationUID: string;  // Changed from applicationId to UID
  }>>([]);

  // Applications fetch with appUID
  React.useEffect(() => {
    const fetchApplications = async () => {
      try {
        const response = await axios.get(
          'http://uklvauems02a.uk.standardchartered.com:8083/fmces/v1/applicationsWithCountOfFeaturesAndActions'
        );
        const apps = response.data.map((item: any) => ({
          "app name": item.appName,
          "app id": String(item.appID),
          "appUID": String(item.appUID), // Added UID
          "appDesc": item.appDesc,
          "number of features": String(item.totalNumberOfFeatures),
          "number of actions": String(item.totalNumberOfActions),
          status: item.isActive ? "Enabled" : "Disabled",
          "last modified": new Date(item.lastUpdated).toLocaleDateString(),
          features: item.features,
          actions: item.actions,
        }));
        setTabRow(apps);
        setRowCount(apps.length);
      } catch (error) {
        console.error('Error fetching applications', error);
      }
    };
    fetchApplications();
  }, []);

  // Features fetch with UID mapping
  React.useEffect(() => {
    if (activeAppTab !== "2") return;
    const fetchFeatures = async () => {
      try {
        const resp = await axios.get(
          'http://uklvauems02a.uk.standardchartered.com:8083/fmces/v1/features'
        );
        const feats = resp.data.map((f: any) => ({
          name: f.featureName,
          featureId: String(f.featureId),
          status: f.application.isActive ? 'Enabled' : 'Disabled',
          usersAssigned: '-',
          lastModified: new Date(f.lastUpdated).toLocaleDateString(),
          applicationUID: String(f.application.appUID), // Map to UID
        }));
        setFeaturesData(feats);
      } catch (err) {
        console.error('Error fetching features', err);
      }
    };
    fetchFeatures();
  }, [activeAppTab]);

  // Only modify Features tab rendering
  const renderAppFeature = () => (
    <div>
      {tabRow
        .filter(app => parseInt(app["number of features"]) > 0)
        .map(app => {
          const rows = featuresData.filter(f => 
            f.applicationUID === app.appUID // Match via UID
          );
          
          return (
            <Box key={app["app id"]} sx={{ border: '1px solid #444', p: 2, borderRadius: 1, backgroundColor: '#1A2028', mt: 2 }}>
              <Typography variant="h6" sx={{ color: 'white' }}>{`${app["app id"]} - ${app["app name"]}`}</Typography>
              <Box sx={{ mt: 1 }}>
                <MaterialTable
                  tableRows={rows}
                  globalSearch={false}
                  tableCols={[
                    { accessorKey: 'name', header: 'Feature Name' },
                    { accessorKey: 'featureId', header: 'Feature ID' },
                    {
                      accessorKey: 'status', 
                      header: 'Status',
                      Cell: ({ cell }: any) => (
                        <Box component="span" sx={{ 
                          backgroundColor: cell.getValue() === 'Enabled' ? '#2BCBC11A' : '#ff00001A', 
                          borderRadius: '20px', 
                          color: cell.getValue() === 'Enabled' ? '#2BCBC1' : '#ff0000', 
                          p: '0.25rem 0.5rem' 
                        }}>
                          {cell.getValue()}
                        </Box>
                      )
                    },
                    { accessorKey: 'usersAssigned', header: 'Users Assigned' },
                    { accessorKey: 'lastModified', header: 'Last Modified' },
                  ]}
                />
              </Box>
            </Box>
          );
        })}
    </div>
  );

  // Keep original Actions tab implementation unchanged
  const renderAppAction = () => (
    <div>
      {tabRow.map(app => (
        <Box key={app["app id"]} sx={{ border: '1px solid #444', p: 2, borderRadius: 1, backgroundColor: '#1A2028', mt: 2 }}>
          <Typography variant="h6" sx={{ color: 'white' }}>{`${app["app id"]} - ${app["app name"]}`}</Typography>
          <Box sx={{ mt: 1 }}>
            <MaterialTable
              tableRows={app.actions || []}
              globalSearch={false}
              tableCols={[
                { accessorKey: 'name', header: 'Action Name' },
                { accessorKey: 'actionId', header: 'Action ID' },
                { accessorKey: 'status', header: 'Status' },
                { accessorKey: 'usersAssigned', header: 'Users Assigned' },
                { accessorKey: 'lastModified', header: 'Last Modified' },
              ]}
            />
          </Box>
        </Box>
      ))}
    </div>
  );
